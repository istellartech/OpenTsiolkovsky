# OpenTsiolkovsky Rust移植 要求書

## 1. プロジェクト概要

### 1.1 目的
現在C++で実装されているOpenTsiolkovskyロケット飛行シミュレータをRustに移植し、可視化部分をTypeScriptでWebブラウザ対応にする。

### 1.2 背景
- パフォーマンスとメモリ安全性の向上
- モダンなWebベース可視化環境の提供
- クロスプラットフォーム対応の強化

## 2. 機能要件

### 2.1 コアシミュレーション機能（Rust実装）

#### 2.1.1 飛行シミュレーション
- **3自由度飛行シミュレーション**: 位置と速度の時系列計算
- **6自由度飛行シミュレーション**: 姿勢制御システム（TVC等）を含む完全シミュレーション
- **3段式ロケット対応**: 段分離を含む多段ロケットシミュレーション
- **軌道計算**: 準軌道および低軌道への投入シミュレーション

#### 2.1.2 物理モデル
- **重力モデル**: WGS84楕円体を基準とした重力場計算
- **大気モデル**: 国際標準大気（ISA）による大気密度・温度・圧力計算
- **空気力学**: 抗力・法線力係数による空力計算
- **推力モデル**: 比推力・推力のファイル入力対応、真空・海面レベル補正

#### 2.1.3 座標変換
- **LLH ↔ ECEF座標変換**: 地心地固座標系との相互変換
- **ECEF ↔ ECI座標変換**: 地心慣性座標系との相互変換  
- **NED座標系**: 局所座標系でのベクトル演算

#### 2.1.4 環境要因
- **風モデル**: 高度別風速・風向データの読み込み対応
- **大気密度変動**: 標準値からの偏差設定機能
- **モンテカルロシミュレーション**: パラメータ変動による統計解析

### 2.2 入出力機能

#### 2.2.1 入力フォーマット
- **JSON設定ファイル**: パラメータファイル（現行互換）
- **CSV データファイル**: 推力・比推力・姿勢等の時系列データ
- **コマンドライン引数**: 設定ファイルパス指定

#### 2.2.2 出力フォーマット
- **CSV出力**: 軌道データ、状態変数の時系列出力
- **JSON出力**: パラメータ情報、統計情報
- **ログ出力**: 計算進捗、エラー情報

### 2.3 可視化機能（TypeScript/Web実装）

#### 2.3.1 2D可視化
- **軌道プロット**: 高度・速度・加速度の時系列グラフ
- **統計グラフ**: モンテカルロ結果の分布表示
- **パラメータ比較**: 複数シミュレーション結果の重ね合わせ

#### 2.3.2 3D可視化
- **3D軌道表示**: 地球上でのロケット軌道の3次元表示
- **地図統合**: 地理的背景との統合表示
- **アニメーション**: 時系列での軌道再生機能

#### 2.3.3 インタラクティブ機能
- **パラメータ調整**: Webインターフェースでの設定変更
- **リアルタイム計算**: パラメータ変更時の即座再計算
- **結果エクスポート**: グラフ・データのダウンロード機能

## 3. 非機能要件

### 3.1 性能要件
- **計算性能**: 現行C++版と同等以上の計算速度
- **メモリ使用量**: 大規模モンテカルロ実行時の効率的メモリ管理
- **レスポンス時間**: Web UIでの操作応答時間 < 100ms

### 3.2 品質要件
- **精度保持**: 現行版との数値精度互換性（相対誤差 < 1e-10）
- **安定性**: メモリ安全性の保証、パニック回避
- **テスト網羅性**: 単体テスト、結合テスト、回帰テストの実装

### 3.3 互換性要件
- **入力ファイル互換**: 既存JSONパラメータファイルの完全サポート
- **出力ファイル互換**: 既存解析ツールとの連携維持
- **プラットフォーム対応**: Windows、macOS、Linux対応

### 3.4 保守性要件
- **モジュール分離**: 機能別のcrate構成
- **ドキュメント**: API文書、設計文書の整備
- **コード品質**: Rustの慣用句に従った実装

## 4. 技術要件

### 4.1 Rust実装要件

#### 4.1.1 使用crate
- **数値計算**: `nalgebra`（線形代数）、`ndarray`（多次元配列）
- **微分方程式**: 自作Runge-Kutta4実装
- **JSON処理**: `serde`、`serde_json`
- **CSV処理**: `csv`
- **並列処理**: `rayon`（モンテカルロ並列化）

#### 4.1.2 プロジェクト構成
```
openTsiolkovsky-rust/
├── core/          # コアシミュレータ
├── physics/       # 物理モデル
├── io/           # 入出力処理
├── tools/        # ユーティリティ
└── wasm/         # WebAssembly bindgen
```

### 4.2 TypeScript/Web要件

#### 4.2.1 フロントエンド技術
- **フレームワーク**: React.js + TypeScript
- **3D描画**: Three.js
- **2Dグラフ**: Chart.js
- **地図表示**: MapboxGL または OpenLayers
- **WebAssembly**: wasm-bindgenによるRust連携
- **その他**: bun, Tailwind CSS(CDN), shadcn/ui

#### 4.2.2 バックエンド
- **API サーバー**: Rust + axum または warp
- **ファイル処理**: 設定・データファイルのアップロード機能
- **計算実行**: WebAssemblyまたはサーバサイド実行

## 5. 制約事項

### 5.1 技術制約
- Boost ODEライブラリの代替実装が必要 →　自作のRunge-Kutta45
- EigenライブラリのRust等価実装（nalgebra）への移行
- 浮動小数点演算の精度保持

### 5.2 運用制約
- 既存ユーザーの移行コストを最小化
- 段階的移行可能な設計（C++版との並行運用）
- 既存Python toolsとの互換性維持

## 6. プロジェクト範囲

### 6.1 Phase 1: コア移植
- C++ src/内のRust移植
- 基本シミュレーション機能の実装
- 入出力互換性の確保

### 6.2 Phase 2: 可視化実装
- Web可視化システムの構築
- WebAssembly統合
- インタラクティブUI実装

### 6.3 Phase 3: 高度機能
- 分散計算対応
- 高度な可視化機能
- パフォーマンス最適化

## 7. 検収基準

### 7.1 機能検収
- 全ての既存テストケースの通過
- 標準サンプルでの結果一致確認
- 新規機能の動作確認

### 7.2 性能検収
- ベンチマークでの性能目標達成
- メモリリーク無し確認
- 長時間実行安定性確認

### 7.3 品質検収
- コードレビュー完了
- テスト網羅率 > 80%
- ドキュメント整備完了